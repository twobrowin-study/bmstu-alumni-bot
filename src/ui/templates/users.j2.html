{% extends "base.j2.html" %}

{% block content %}
  <div>
    {% for field_branch in field_branches %}
      <a href="{{ uri_prefix }}/users/branch/{{ field_branch.id }}"
        class="btn mr-1 
        {% if field_branch.id == curr_field_branch.id %}
          btn-secondary
        {% elif field_branch.status.value == 'normal' %}
          btn-primary
        {% elif field_branch.status.value == 'inactive' %}
          btn-danger
        {% endif %}
        "
      >
        {{ field_branch.key }}
    </a>
    {% endfor %}
  </div>
  <div><br/></div>
  <div>
    <button id="users-download-report" class="btn mr-1 btn-success">{{ i18n.download_users_report }}</button>
  </div>
  <table id="users-table" class="table table-striped">
    <thead>
      <tr>
        <th>{{ i18n.chat_id }}</th>
        <th>{{ i18n.username }}</th>
        {% for field in fields %}
          <th id='fields-{{ field.id }}'>
            {{ field.key }}
            {% if curr_field_branch.is_ui_editable %}
              &nbsp;
              <button  class="col-edit btn btn-outline-primary btn-sm"><i class="bi bi-pencil-square"></i></button>
            {% endif %}
          </th>
        {% endfor %}
      </tr>
    </thead>
    <tbody>
      {% for user in users %}
        <tr id="users-{{ user.id }}">
          <td id="users-{{ user.id }}-chat_id">{{ user.chat_id }}</td>
          <td id="users-{{ user.id }}-username">{% if user.username %}{{ user.username }} {% endif %}</td>
          {% for field in fields %}
            <td id='users-{{ user.id }}-fields-{{ field.id }}'
              {% if curr_field_branch.is_ui_editable %}
                class='col-editable fields-{{ field.id }}'
              {% endif %}
            >
              {% if field.is_boolean %}
                  <select id="users-{{ user.id }}-fields-{{ field.id }}-value" class="form-select" disabled>
                    <option value="false" {% if field.id not in user.fields or  user.fields[field.id].value == 'false' %}selected='true'{% endif %}>{{ i18n.no  }}</option>
                    <option value="true"  {% if field.id     in user.fields and user.fields[field.id].value == 'true'  %}selected='true'{% endif %}>{{ i18n.yes }}</option>
                  </select>
              {% elif field.id in user.fields %}
                {% if field.image_bucket %}
                  <img
                    id='users-{{ user.id }}-fields-{{ field.id }}-image'
                    class="img-thumbnail"
                    alt="{{ user.fields[field.id].value }}"
                    style="max-height: 200px; max-width: 200px;"
                  />
                {% elif field.document_bucket %}
                  <a
                    id='users-{{ user.id }}-fields-{{ field.id }}-document'
                    class="btn btn-sm btn-primary"
                  >
                      {{ i18n.download_file }} {{ user.fields[field.id].value }}
                  </a>
                {% else %}
                  <span style="white-space: pre-line">{{ user.fields[field.id].value }}</span>
                {% endif %}
              {% endif %}
            </td>
          {% endfor %}
        </tr>
      {% endfor %}
    </tbody>
  </table>

  <script>
    $(() => {
      $('#users-download-report').click(() => {
        console.log("Start download full user report")
        $.ajax({
          url: `{{ uri_prefix }}/users/report/xslx`,
          type: 'GET',
          headers: {
            Accept:        "application/vnd.ms-excel",
            Authorization: `Bearer ${keycloak.token}`
          },
          xhrFields: {
              'responseType': 'blob'
          },
          success: (data, status, xhr) => {
            var link = document.createElement('a'),
                filename = 'file.xlsx';
            if(xhr.getResponseHeader('Content-Disposition')){//имя файла
                filename = xhr.getResponseHeader('Content-Disposition');
                filename=filename.match(/filename="(.*?)"/)[1];
                filename=decodeURIComponent(escape(filename));
            }
            link.href = URL.createObjectURL(data);
            link.download = filename;
            link.click();
          }
        })
      })
    })
  </script>

  <script>
    function load_users_images() {
      {% for user in users %}
            {% for field in fields %}
                {% if field.id in user.fields and user.fields[field.id].image_bucket %}
                  $(() => {
                    const doc_id = '#users-{{ user.id }}-fields-{{ field.id }}-image'
                    console.log(`Start loading image ${doc_id}`);
                    $.ajax({
                      url:  `{{ uri_prefix }}/minio/base64/{{ user.fields[field.id].image_bucket }}/{{ user.fields[field.id].value }}`,
                      type: 'GET',
                      tryCount:   0,
                      retryLimit: 3,
                      headers: {
                        Accept:        "application/json",
                        Authorization: `Bearer ${keycloak.token}`
                      },
                      success: (res) => {
                        $(doc_id).attr('src', `data:${res.mime};base64,${res.image}`);
                      },
                      error : function(xhr, textStatus, errorThrown ) {
                        if (textStatus == 'timeout') {
                            this.tryCount++;
                            if (this.tryCount <= this.retryLimit) {
                                console.log(`Retrying get document ${doc_id}`);
                                setTimeout(() => $.ajax(this), 500);
                                return;
                            }
                            console.log(`Could not retry anymore to get document ${doc_id}`);
                            return;
                        }
                        console.log(`Got ${xhr.status} error for document ${doc_id}`)
                    }
                    });
                  });
                {% endif %}
            {% endfor %}
        {% endfor %}
    }
  </script>

  <script>
    $(() => {
      function waitForKeycloakToken() {
        if (!keycloak.hasOwnProperty('token')) {
          console.log("Does not have token to load images and documents yet")
          return setTimeout(waitForKeycloakToken, 250);
        }
        console.log("Have token to load images and documents!");
        load_users_images();
      }
      waitForKeycloakToken();
    });
  </script>


  <script>
    {% for user in users %}
      {% for field in fields %}
          {% if field.id in user.fields and user.fields[field.id].document_bucket %}
            $(() => {
              $("#users-{{ user.id }}-fields-{{ field.id }}-document").click(() => {
                $.ajax({
                  url:  `{{ uri_prefix }}/minio/{{ user.fields[field.id].document_bucket }}/{{ user.fields[field.id].value }}`,
                  type: 'GET',
                  tryCount:   0,
                  retryLimit: 3,
                  headers: {
                    Accept:        "*/*",
                    Authorization: `Bearer ${keycloak.token}`
                  },
                  xhrFields: {
                      'responseType': 'blob'
                  },
                  success: (data, status, xhr) => {
                    var link = document.createElement('a');
                    link.href = URL.createObjectURL(data);
                    link.download = '{{ user.fields[field.id].value }}';
                    link.click();
                  }
                });
              });
            });
          {% endif %}
      {% endfor %}
    {% endfor %}
  </script>
{% endblock %}
